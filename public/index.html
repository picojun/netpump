<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>weblink</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <style>
      html,
      body {
        height: 100%;
        background-color: #3f9cff;
        font-family: arial, sans-serif;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: white;
      }
      dd {
        margin: 0;
      }
      input[type="checkbox"] {
        margin-right: 0.5em;
      }
    </style>
  </head>
  <body>
    <h1>weblink</h1>
    <div class="settings">
      <label
        ><input type="checkbox" id="nosleep" />Prevent screen from
        sleeping</label
      >
    </div>
    <dl class="stats">
      <dt>Connections</dt>
      <dd id="connectionCount">0</dd>
    </dl>
    <script>
      function createRelayWebSocketPair(localAddr, remoteAddr) {
        // Local websocket.
        var local;
        // Connect to the remote websocket server first, so that when we
        // connect to the local websocket server the whole chain is ready to
        // use immediately.
        var remote = new WebSocket(remoteAddr + "/ws/rem/relay");
        // Log server errors.
        remote.onerror = function (event) {
          console.error("[!] remote/error", event);
        };
        // When the remote server closes its websocket, close the corresponding
        // local websocket too.
        remote.onclose = function (event) {
          console.log("[-] remote/close", {
            code: event.code,
            reason: event.reason,
            wasClean: event.wasClean,
          });
          if (local?.readyState === WebSocket.OPEN) {
            local.close(1000, `bound close: ${event.code} ${event.reason}`);
          }
        };
        remote.onopen = function () {
          // Connect to the local websocket server to relay data.
          local = new WebSocket(localAddr + "/ws/loc/relay");
          // Log relay errors.
          local.onerror = function (event) {
            console.error("[!] local/error", event);
          };
          // When the local websocket is closed, close the corresponding
          // remote websocket.
          local.onclose = function (event) {
            if (local.cleanOpen) {
              connections--;
              connectionCount.textContent = connections;
            }
            console.log("[-] local/close", {
              code: event.code,
              reason: event.reason,
              wasClean: event.wasClean,
            });
            if (remote.readyState === WebSocket.OPEN) {
              remote.close(1000, `bound close: ${event.code} ${event.reason}`);
            }
          };
          // Relay data between the local and remote websockets.
          local.onopen = function () {
            connections++;
            connectionCount.textContent = connections;
            local.cleanOpen = true;

            local.onmessage = function (msg) {
              remote.send(msg.data);
            };
            remote.onmessage = function (msg) {
              local.send(msg.data);
            };
          };
        };
      }
      // Get the query params.
      var params = {};
      window.location.href.replace(
        /[?&]+([^=&]+)=([^&]*)/g,
        function (m, key, value) {
          params[key] = decodeURIComponent(value);
        },
      );
      // Local weblink server.
      var localAddr = "ws://" + location.host;
      // Remote weblink server.
      var remoteAddr = params.server || "wss://weblink-ouux.onrender.com";
      // Establish a local control websocket to receive commands.
      var control = new WebSocket(localAddr + "/ws/loc/control");
      // Total number of local connections.
      var connections = 0;
      // Log control websocket errors.
      control.onerror = function (event) {
        console.error("[!] control/error", event);
      };
      // Log control websocket closure.
      control.onclose = function (event) {
        console.log("[-] control/close", {
          code: event.code,
          reason: event.reason,
        });
      };
      // Add more connections on demand.
      control.onmessage = function (msg) {
        var connectionBatchSize = Number.parseInt(msg.data);
        console.log("[~] control/batch", { count: connectionBatchSize });
        for (var i = 0; i < connectionBatchSize; i++) {
          createRelayWebSocketPair(localAddr, remoteAddr);
        }
      };
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"
      type="text/javascript"
      crossorigin="anonymous"
    ></script>
    <script src="nosleep.js" type="text/javascript"></script>
  </body>
</html>
