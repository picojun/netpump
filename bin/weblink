#!/usr/bin/env -S ruby

$VERBOSE = nil
$>.sync = true
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)

require "optparse"
require "uri"
require "weblink"

opts = {}

op = OptionParser.new do |op|
  op.summary_width = 24

  op.banner =
    "Usage: weblink [options]\n" \
    "Web browser gateway"

  op.separator ""
  op.separator "Options"

  op.on("-c", "--client", "start weblink client (default)") do
    opts[:client] = true
  end

  op.on("-s", "--server", "start weblink server") do
    opts[:server] = true
  end

  op.on("-h", "--host HOST", String, "weblink server host (default: 0.0.0.0)") do |host|
    opts[:host] = host
  end

  op.on("-p", "--port PORT", Integer, "weblink server port (default: 8080)") do |port|
    opts[:port] = port
  end

  op.on("--proxy-host HOST", String, "proxy server host (default: 0.0.0.0)") do |host|
    opts[:proxy_host_loc] = host
  end

  op.on("--proxy-port PORT", Integer, "proxy server port (default: 3128)") do |port|
    opts[:proxy_port_loc] = port
  end

  op.on_tail("--version", "print version") do
    version = File.expand_path("../VERSION", __dir__)
    puts(File.read(version))
    exit
  end

  op.on_tail("--help", "print this help") do
    puts(op)
    exit
  end
end

begin
  op.parse!
rescue OptionParser::ParseError => e
  op.abort(e)
end

weblink = Weblink.new(**opts)
weblink.run
